# Docker Compose configuration for production environment
# Usage: docker-compose -f docker-compose.prod.yml up -d

services:
    slatehub:
        build:
            context: ./server
            dockerfile: Dockerfile
        image: slatehub:latest
        container_name: slatehub-server
        ports:
            - "${SERVER_PORT:-80}:3000"
        environment:
            # Server configuration
            SERVER_HOST: 0.0.0.0
            SERVER_PORT: 3000

            # Database configuration
            DB_HOST: surrealdb
            DB_PORT: 8000
            DB_USERNAME: ${DB_USERNAME}
            DB_PASSWORD: ${DB_PASSWORD}
            DB_NAMESPACE: ${DB_NAMESPACE:-slatehub}
            DB_NAME: ${DB_NAME:-main}

            # S3 configuration (can be AWS S3 or MinIO)
            S3_ENDPOINT: ${S3_ENDPOINT:-http://minio:9000}
            S3_REGION: ${S3_REGION:-us-east-1}
            S3_ACCESS_KEY_ID: ${S3_ACCESS_KEY_ID}
            S3_SECRET_ACCESS_KEY: ${S3_SECRET_ACCESS_KEY}
            S3_BUCKET: ${S3_BUCKET:-slatehub}

            # Production logging - less verbose
            RUST_LOG: ${RUST_LOG:-info,slatehub=info}
            LOG_FORMAT: ${LOG_FORMAT:-json}

            # Production-specific settings
            ENVIRONMENT: production
            JWT_SECRET: ${JWT_SECRET}
            SESSION_SECRET: ${SESSION_SECRET}
            SESSION_SECURE: ${SESSION_SECURE:-true}
            SESSION_DOMAIN: ${SESSION_DOMAIN}

            # Security settings
            RATE_LIMIT_REQUESTS: ${RATE_LIMIT_REQUESTS:-100}
            RATE_LIMIT_WINDOW_SECS: ${RATE_LIMIT_WINDOW_SECS:-60}

            # Feature flags
            ENABLE_REGISTRATION: ${ENABLE_REGISTRATION:-false}
            ENABLE_PUBLIC_PROJECTS: ${ENABLE_PUBLIC_PROJECTS:-false}
            MAX_UPLOAD_SIZE_MB: ${MAX_UPLOAD_SIZE_MB:-100}
        depends_on:
            - surrealdb
            - minio
        networks:
            - slatehub-network
        restart: always
        deploy:
            resources:
                limits:
                    memory: 512M
                reservations:
                    memory: 256M
        healthcheck:
            test:
                [
                    "CMD-SHELL",
                    "wget --no-verbose --tries=1 --spider http://localhost:3000/health || exit 1",
                ]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s

    surrealdb:
        image: surrealdb/surrealdb:latest
        container_name: slatehub-surrealdb
        ports:
            - "127.0.0.1:8000:8000" # Only expose locally
        volumes:
            - surrealdb-data:/data
        user: root
        command: start --log info --user ${DB_USERNAME} --pass ${DB_PASSWORD} rocksdb://data/database.db
        environment:
            SURREAL_LOG: info
        networks:
            - slatehub-network
        restart: always
        deploy:
            resources:
                limits:
                    memory: 1G
                reservations:
                    memory: 512M
        healthcheck:
            test:
                [
                    "CMD-SHELL",
                    "wget --no-verbose --tries=1 --spider http://localhost:8000/health || exit 1",
                ]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 30s

    minio:
        image: minio/minio:latest
        container_name: slatehub-minio
        ports:
            - "127.0.0.1:9000:9000" # Only expose locally
            # Console disabled in production for security
        volumes:
            - minio-data:/data
        user: root
        environment:
            MINIO_ROOT_USER: ${S3_ACCESS_KEY_ID}
            MINIO_ROOT_PASSWORD: ${S3_SECRET_ACCESS_KEY}
            MINIO_BROWSER: "off" # Disable console in production
        command: server /data
        networks:
            - slatehub-network
        restart: always
        deploy:
            resources:
                limits:
                    memory: 512M
                reservations:
                    memory: 256M
        healthcheck:
            test:
                [
                    "CMD-SHELL",
                    "curl -f http://localhost:9000/minio/health/live || exit 1",
                ]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 30s

    # Optional: Nginx reverse proxy for production
    # nginx:
    #     image: nginx:alpine
    #     container_name: slatehub-nginx
    #     ports:
    #         - "80:80"
    #         - "443:443"
    #     volumes:
    #         - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    #         - ./nginx/ssl:/etc/nginx/ssl:ro
    #         - nginx-cache:/var/cache/nginx
    #     depends_on:
    #         - slatehub
    #     networks:
    #         - slatehub-network
    #     restart: always

volumes:
    surrealdb-data:
        driver: local
    minio-data:
        driver: local
    # nginx-cache:
    #     driver: local

networks:
    slatehub-network:
        driver: bridge
        ipam:
            config:
                - subnet: 172.20.0.0/16
