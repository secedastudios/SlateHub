{% extends "_layout.html" %}

{% block title %}{{ page_title }} - SlateHub{% endblock %}
{% block page_name %}equipment-detail{% endblock %}

{% block content %}
<section id="section-equipment-detail" data-component="equipment-detail">
    <header data-role="detail-header">
        <h1 id="heading-equipment">{{ equipment.name }}</h1>
        <div data-role="status-indicator">
            <span data-role="status-badge"
                  data-status="{% if equipment.is_available %}available{% else %}unavailable{% endif %}">
                {% if equipment.is_available %}Available{% else %}In Use{% endif %}
            </span>
            {% if equipment.is_kit_item %}
            <span data-role="kit-indicator">
                Part of Kit
                {% if equipment.parent_kit.is_some() %}
                - <a href="/equipment/kit/{{ equipment.parent_kit.as_ref().unwrap() }}">View Kit</a>
                {% endif %}
            </span>
            {% endif %}
        </div>
    </header>

    {% if error_message.is_some() %}
    <div id="error-message" data-component="alert" data-type="error" role="alert">
        {{ error_message.as_ref().unwrap() }}
    </div>
    {% endif %}

    {% if can_edit %}
    <nav id="equipment-actions" data-component="action-bar">
        <ul data-role="actions">
            <li>
                <a href="/equipment/{{ equipment.id }}/edit"
                   role="button"
                   data-type="primary">
                    Edit Equipment
                </a>
            </li>
            {% if equipment.is_available %}
            <li>
                <a href="/equipment/checkout?equipment_id={{ equipment.id }}"
                   role="button"
                   data-type="action">
                    Check Out
                </a>
            </li>
            {% endif %}
            <li>
                <form method="post" action="/equipment/{{ equipment.id }}/delete" data-component="delete-form">
                    <button type="submit"
                            data-type="danger"
                            onclick="return confirm('Are you sure you want to delete this equipment?');">
                        Delete
                    </button>
                </form>
            </li>
        </ul>
    </nav>
    {% else %}
        {% if equipment.is_available %}
        <nav id="equipment-actions" data-component="action-bar">
            <ul data-role="actions">
                <li>
                    <a href="/equipment/checkout?equipment_id={{ equipment.id }}"
                       role="button"
                       data-type="action">
                        Check Out
                    </a>
                </li>
            </ul>
        </nav>
        {% endif %}
    {% endif %}

    <div data-component="detail-grid" data-layout="two-column">
        <section id="section-equipment-info" data-section="info">
            <h2 id="heading-info">Equipment Information</h2>

            <dl data-component="info-list">
                <dt>Category</dt>
                <dd data-field="category">{{ equipment.category.name }}</dd>

                {% if equipment.serial_number.is_some() %}
                <dt>Serial Number</dt>
                <dd data-field="serial">{{ equipment.serial_number.as_ref().unwrap() }}</dd>
                {% endif %}

                {% if equipment.model.is_some() %}
                <dt>Model</dt>
                <dd data-field="model">{{ equipment.model.as_ref().unwrap() }}</dd>
                {% endif %}

                {% if equipment.manufacturer.is_some() %}
                <dt>Manufacturer</dt>
                <dd data-field="manufacturer">{{ equipment.manufacturer.as_ref().unwrap() }}</dd>
                {% endif %}

                <dt>Condition</dt>
                <dd data-field="condition">
                    {{ equipment.condition.name }}
                    {% if equipment.condition.description.is_some() %}
                    <span data-role="condition-description">- {{ equipment.condition.description.as_ref().unwrap() }}</span>
                    {% endif %}
                </dd>

                {% if equipment.current_location.is_some() %}
                <dt>Current Location</dt>
                <dd data-field="location">{{ equipment.current_location.as_ref().unwrap() }}</dd>
                {% endif %}

                {% if equipment.description.is_some() %}
                <dt>Description</dt>
                <dd data-field="description">{{ equipment.description.as_ref().unwrap() }}</dd>
                {% endif %}

                {% if equipment.notes.is_some() %}
                <dt>Notes</dt>
                <dd data-field="notes">{{ equipment.notes.as_ref().unwrap() }}</dd>
                {% endif %}
            </dl>

            <h3 id="heading-purchase">Purchase Information</h3>
            <dl data-component="purchase-info">
                {% if equipment.purchase_date.is_some() %}
                <dt>Purchase Date</dt>
                <dd data-field="purchase-date">
                    <time datetime="{{ equipment.purchase_date.as_ref().unwrap().to_rfc3339() }}">
                        {{ equipment.purchase_date.as_ref().unwrap().format("%B %d, %Y") }}
                    </time>
                </dd>
                {% endif %}

                {% if equipment.purchase_price.is_some() %}
                <dt>Purchase Price</dt>
                <dd data-field="purchase-price">${{ equipment.purchase_price.as_ref().unwrap() }}</dd>
                {% endif %}
            </dl>

            <h3 id="heading-metadata">System Information</h3>
            <dl data-component="metadata">
                <dt>Created</dt>
                <dd data-field="created">
                    <time datetime="{{ equipment.created_at.to_rfc3339() }}">
                        {{ equipment.created_at.format("%B %d, %Y at %I:%M %p") }}
                    </time>
                </dd>

                <dt>Last Updated</dt>
                <dd data-field="updated">
                    <time datetime="{{ equipment.updated_at.to_rfc3339() }}">
                        {{ equipment.updated_at.format("%B %d, %Y at %I:%M %p") }}
                    </time>
                </dd>

                <dt>Owner</dt>
                <dd data-field="owner">
                    {% if equipment.owner_type == "person" && equipment.owner_person.is_some() %}
                    Personal - <a href="/{{ equipment.owner_person.as_ref().unwrap() }}">View Profile</a>
                    {% else if equipment.owner_type == "organization" && equipment.owner_organization.is_some() %}
                    Organization - <a href="/orgs/{{ equipment.owner_organization.as_ref().unwrap() }}">View Organization</a>
                    {% endif %}
                </dd>
            </dl>
        </section>

        <aside id="aside-equipment-qr" data-section="sidebar">
            {% if equipment.qr_code.is_some() %}
            <section data-component="qr-section">
                <h3 id="heading-qr">QR Code</h3>
                <div data-component="qr-code" data-code="{{ equipment.qr_code.as_ref().unwrap() }}">
                    <img src="/api/qr/{{ equipment.qr_code.as_ref().unwrap() }}"
                         alt="QR Code for {{ equipment.name }}"
                         data-role="qr-image">
                    <p data-role="qr-label">{{ equipment.qr_code.as_ref().unwrap() }}</p>
                </div>
            </section>
            {% endif %}

            <section data-component="quick-stats">
                <h3 id="heading-stats">Quick Stats</h3>
                <dl data-component="stats-list">
                    <dt>Total Rentals</dt>
                    <dd data-field="total-rentals">{{ rentals.len() }}</dd>

                    <dt>Currently Rented</dt>
                    <dd data-field="current-rental">
                        {% if !equipment.is_available %}
                        Yes
                        {% else %}
                        No
                        {% endif %}
                    </dd>
                </dl>
            </section>
        </aside>
    </div>

    <section id="section-rental-history" data-section="history">
        <h2 id="heading-history">Rental History</h2>

        {% if rentals.is_empty() %}
        <div data-component="empty-state" data-state="empty">
            <p data-role="empty-message">No rental history for this equipment.</p>
        </div>
        {% else %}
        <table id="table-rentals" data-component="rental-table">
            <thead>
                <tr>
                    <th scope="col">Renter</th>
                    <th scope="col">Checkout Date</th>
                    <th scope="col">Return Date</th>
                    <th scope="col">Checkout Condition</th>
                    <th scope="col">Return Condition</th>
                    <th scope="col">Status</th>
                    <th scope="col">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for rental in rentals %}
                <tr data-rental-id="{{ rental.id }}"
                    data-status="{% if rental.is_active %}active{% else %}completed{% endif %}">
                    <td data-field="renter">
                        {% if rental.renter_type == "person" && rental.renter_person.is_some() %}
                        <a href="/{{ rental.renter_person.as_ref().unwrap() }}">Person</a>
                        {% else if rental.renter_type == "organization" && rental.renter_organization.is_some() %}
                        <a href="/orgs/{{ rental.renter_organization.as_ref().unwrap() }}">Organization</a>
                        {% endif %}
                    </td>
                    <td data-field="checkout-date">
                        <time datetime="{{ rental.checkout_date.to_rfc3339() }}">
                            {{ rental.checkout_date.format("%m/%d/%Y") }}
                        </time>
                    </td>
                    <td data-field="return-date">
                        {% if rental.actual_return_date.is_some() %}
                        <time datetime="{{ rental.actual_return_date.as_ref().unwrap().to_rfc3339() }}">
                            {{ rental.actual_return_date.as_ref().unwrap().format("%m/%d/%Y") }}
                        </time>
                        {% else if rental.expected_return_date.is_some() %}
                        <time datetime="{{ rental.expected_return_date.as_ref().unwrap().to_rfc3339() }}">
                            Expected: {{ rental.expected_return_date.as_ref().unwrap().format("%m/%d/%Y") }}
                        </time>
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td data-field="checkout-condition">{{ rental.checkout_condition.name }}</td>
                    <td data-field="return-condition">
                        {% if rental.return_condition.is_some() %}
                        {{ rental.return_condition.as_ref().unwrap().name }}
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td data-field="status">
                        <span data-role="status-badge"
                              data-status="{% if rental.is_active %}active{% else %}completed{% endif %}">
                            {% if rental.is_active %}Active{% else %}Returned{% endif %}
                        </span>
                    </td>
                    <td data-field="actions">
                        {% if rental.is_active && can_edit %}
                        <a href="/equipment/rental/{{ rental.id }}/checkin"
                           role="button"
                           data-type="action">
                            Check In
                        </a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}
    </section>
</section>
{% endblock %}
